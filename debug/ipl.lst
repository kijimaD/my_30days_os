GAS LISTING ipl.s 			page 1


   1              	.text
   2              	.code16
   3              	
   4 0000 EB4E     	jmp entry
   5 0002 90       	.byte   0x90           # ブートセレクタの名前(8byte)
   6 0003 48454C4C 	.ascii  "HELLOIPL"     # 1セクタの大きさ
   6      4F49504C 
   7 000b 0002     	.word   512            # クラスタの大きさ
   8 000d 01       	.byte   1              # FATがどこから始まるか
   9 000e 0100     	.word   1              # FATの個数
  10 0010 02       	.byte   2              # ルートディレクトリ領域の大きさ
  11 0011 E000     	.word   224            # このドライブの大きさ
  12 0013 400B     	.word   2880           # メディアタイプ
  13 0015 F0       	.byte   0xf0           # FAT領域の長さ
  14 0016 0900     	.word   9              # 1トラックにいくつのセクタがあるか
  15 0018 1200     	.word   18             # ヘッドの数
  16 001a 0200     	.word   2              # パーティションを使っていないのでここは必ず0
  17 001c 00000000 	.int    0              # このドライブの大きさをもう一度書く
  18 0020 400B0000 	.int    2880           # よくわからないけどこの値にしておくといいらしい
  19 0024 000029   	.byte   0, 0, 0x29     # たぶんボリュームシリアル番号
  20 0027 FFFFFFFF 	.int    0xffffffff     # ディスクの名前(11byte)
  21 002b 48454C4C 	.ascii  "HELLO-OS   "  # フォーマットの名前(8byte)
  21      4F2D4F53 
  21      202020
  22 0036 46415431 	.ascii  "FAT12   "     # とりあえず18バイト空けておく。0x00で埋める
  22      32202020 
  23 003e 00000000 	.skip   18, 0
  23      00000000 
  23      00000000 
  23      00000000 
  23      0000
  24              	
  25              	# シリンダ数
  26              	.set CYLS, 10
  27              	# シリンダ数のメモリ位置
  28              	.set _CYLS, 0xff0
  29              	
  30              	entry:
  31              	        # init register
  32 0050 B80000   	        movw $0, %ax
  33 0053 8ED0     	        movw %ax, %ss
  34 0055 BC007C   	        movw $0x7c00, %sp # メモリ上のブートセクタ開始アドレス
  35 0058 8ED8     	        movw %ax, %ds     # DSはデータセグメント
  36              	
  37              	        # load disk
  38 005a B82008   	        movw $0x0820, %ax
  39 005d 8EC0     	        movw %ax, %es     # buffer address(ES:BX)
  40 005f B500     	        movb $0, %ch      # cylinder 0
  41 0061 B600     	        movb $0, %dh      # head 0
  42 0063 B102     	        movb $2, %cl      # sector 2
  43              	
  44              	readloop:
  45 0065 BE0000   	        movw $0, %si # retry counter
  46              	
  47              	retry:
  48 0068 B402     	        movb $0x02, %ah   # ah=0x02 read
  49 006a B001     	        movb $1, %al      # 1 sector
GAS LISTING ipl.s 			page 2


  50 006c BB0000   	        movw $0, %bx      # buffer address(ES:BX)
  51 006f B200     	        movb $0x00, %dl   # drive A
  52 0071 CD13     	        int  $0x13        # interrupt bios
  53 0073 7310     	        jnc  next         # エラーがなければ次へ
  54              	
  55 0075 83C601   	        addw $1, %si      # エラーカウントをカウントアップ
  56 0078 83FE05   	        cmp  $5, %si
  57 007b 7336     	        jae  error        # エラーカウント5回でエラー処理へ
  58              	
  59              	        # 再実行前にドライブ情報をリセット(drive A)
  60 007d B400     	        movb $0x00, %ah
  61 007f B200     	        movb $0x00, %dl   # drive A
  62 0081 CD13     	        int  $0x13
  63              	
  64 0083 EBE3     	        jmp retry
  65              	
  66              	next:
  67 0085 8CC0     	        movw %es, %ax
  68              	        # 512 / 16 = 0x20
  69              	        # 対象のアドレスは(ES x 16 + BX)でキマるので、ESを0x20ずらすと、512byt
  70 0087 83C020   	        add $0x20, %ax
  71 008a 8EC0     	        movw %ax, %es
  72 008c 80C101   	        add $1, %cl
  73 008f 80F912   	        cmp $18, %cl # セクター18まで読み込む
  74 0092 76D1     	        jbe readloop # 以下ならループ
  75              	
  76 0094 B101     	        movb $1, %cl
  77 0096 80C601   	        add $1, %dh
  78 0099 80FE02   	        cmp $2, %dh
  79 009c 72C7     	        jb readloop # より下ならループ
  80              	
  81 009e B600     	        movb $0, %dh
  82 00a0 80C501   	        addb $1, %ch
  83 00a3 80FD0A   	        cmp $CYLS, %ch
  84 00a6 72BD     	        jb readloop # より下ならループ
  85              	
  86 00a8 C606F00F 	        movb $CYLS, (_CYLS)
  86      0A
  87              	        # jump to os program
  88              	        # 0x0800(buffer address) + 0x4200(first file place of FAT12)
  89              	        # セクタ2から先をメモリアドレス0x0820を先頭としてロード(0x0800-0x082
  90              	        # ディスクイメージ上0x4200の位置にあるOSのプログラムは、0x0800 + 0x4
  91 00ad E90000   	        jmp 0xc200
  92              	
  93              	fin:
  94 00b0 F4       	        hlt               # CPUを停止
  95 00b1 EBFD     	        jmp fin           # 無限ループさせる
  96              	
  97              	error:
  98 00b3 BE0000   	        movw $msg, %si    # msgのアドレスをロードする
  99              	
 100              	putloop:
 101 00b6 8A04     	        movb (%si), %al
 102 00b8 83C601   	        addw $1, %si
 103 00bb 3C00     	        cmpb $0, %al
 104 00bd 74F1     	        je fin
 105 00bf B40E     	        movb $0x0e, %ah
GAS LISTING ipl.s 			page 3


 106 00c1 BB0F00   	        movw $15, %bx
 107 00c4 CD10     	        int $0x10         # BIOSの文字出力割り込み
 108 00c6 EBEE     	        jmp putloop       # 次の文字
 109              	
 110              	msg:
 111 00c8 0A6C6F61 	        .string "\nload error!\n\n"
 111      64206572 
 111      726F7221 
 111      0A0A00
 112              	
 113              	# end of boot sector
 114 00d7 00000000 	.org    0x01fe            # ここまでのバイナリサイズを510バイトに揃える
 114      00000000 
 114      00000000 
 114      00000000 
 114      00000000 
 115 01fe 55AA     	.byte   0x55, 0xaa        # ブートセクタのシグネチャ
GAS LISTING ipl.s 			page 4


DEFINED SYMBOLS
               ipl.s:30     .text:0000000000000050 entry
               ipl.s:26     *ABS*:000000000000000a CYLS
               ipl.s:28     *ABS*:0000000000000ff0 _CYLS
               ipl.s:44     .text:0000000000000065 readloop
               ipl.s:47     .text:0000000000000068 retry
               ipl.s:66     .text:0000000000000085 next
               ipl.s:97     .text:00000000000000b3 error
               ipl.s:93     .text:00000000000000b0 fin
               ipl.s:110    .text:00000000000000c8 msg
               ipl.s:100    .text:00000000000000b6 putloop

NO UNDEFINED SYMBOLS
